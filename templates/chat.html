<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Chat web</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }

        #chat {
            height: 60vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        #chat::-webkit-scrollbar {
            width: 8px;
        }

        #chat::-webkit-scrollbar-track {
            background: #161b22;
        }

        #chat::-webkit-scrollbar-thumb {
            background-color: #30363d;
            border-radius: 4px;
            border: 2px solid #161b22;
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4">
    <div
        class="bg-[#161b22] rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-4xl mx-auto border border-[#30363d] flex flex-col h-[90vh]">

        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl md:text-3xl font-extrabold text-[#58a6ff]">Welcome, <span id="user"></span>!</h2>
            <div class="flex items-center space-x-2 text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="lucide lucide-users-2 text-[#c9d1d9]">
                    <path d="M14 19a6 6 0 0 0-12 0" />
                    <circle cx="8" cy="9" r="4" />
                    <path d="M22 19a6 6 0 0 0-6-6 6 6 0 0 0-6 6" />
                    <path d="M16 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                </svg>
                <span id="online-users-count" class="font-bold text-lg">0</span>
            </div>
        </div>
        <div id="chat" class="flex-grow p-4 mb-4 rounded-xl border border-[#30363d] space-y-4 bg-[#0d1117]"></div>

        <div class="flex items-center space-x-2">
            <input id="input" placeholder="Wpisz wiadomość..." autocomplete="off"
                class="flex-grow bg-[#21262d] text-[#c9d1d9] border border-[#30363d] rounded-xl p-3 focus:outline-none focus:border-[#58a6ff]">
            <button id="send" class="bg-[#21262d] text-[#c9d1d9] font-bold py-3 px-6 rounded-xl border border-[#30363d] shadow-lg
                       hover:bg-[#30363d] transition-colors duration-300">
                Send
            </button>
        </div>
    </div>

    <script>
        const socket = io();

        socket.on('connect', () => {
            socket.emit('register_user', {
                username: "{{ username }}"
            });
            socket.emit('user_count');
        });
        socket.on('update_users_online', (data) => {
            const onlineUsersSpan = document.getElementById('online-users-count');
            onlineUsersSpan.innerText = data.count;
        });

        socket.on('nickname_taken', () => {
            alert("This nickname is already in use. Choose a different one.");
            window.location.href = "/login";
        });

        socket.on('registration_successful', () => {
            console.log("Zalogowano pomyślnie.");
        });
        const chat = document.getElementById('chat');
        const input = document.getElementById('input');
        const sendBtn = document.getElementById('send');
        const userSpan = document.getElementById('user');

        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username') || 'anonim';
        const usercolor = urlParams.get('color') || '#c9d1d9';

        userSpan.innerText = username;
        userSpan.style.color = usercolor;

        sendBtn.onclick = () => {
            const msg = input.value.trim();
            if (!msg) return;
            socket.emit('send_message', { username: username, color: usercolor, text: msg });
            input.value = '';
        };

        socket.on('receive_message', (data) => {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'items-start', 'space-x-3');

            const avatar = document.createElement('div');
            avatar.classList.add('w-8', 'h-8', 'rounded-full', 'flex', 'items-center', 'justify-center', 'font-bold', 'text-white', 'text-sm', 'flex-shrink-0');
            avatar.style.backgroundColor = data.color;
            avatar.innerText = data.username.charAt(0).toUpperCase();

            const messageContent = document.createElement('div');
            messageContent.classList.add('bg-[#21262d]', 'p-3', 'rounded-xl', 'max-w-xs', 'md:max-w-md', 'break-words');

            const messageHeader = document.createElement('div');
            messageHeader.classList.add('flex', 'items-center', 'mb-1', 'space-x-2');

            const messageAuthor = document.createElement('span');
            messageAuthor.classList.add('font-bold', 'text-sm');
            messageAuthor.innerText = data.username;
            messageAuthor.style.color = data.color;

            const messageTime = document.createElement('span');
            messageTime.classList.add('text-xs', 'text-gray-500');
            const now = new Date();
            messageTime.innerText = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;

            messageHeader.appendChild(messageAuthor);
            messageHeader.appendChild(messageTime);

            const messageText = document.createElement('p');
            messageText.classList.add('text-sm');
            if (!data.text.startsWith("<img")) {
                messageText.innerText = data.text;
            } else {
                messageText.innerHTML = data.text;
            }

            messageContent.appendChild(messageHeader);
            messageContent.appendChild(messageText);

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);

            chat.appendChild(messageDiv);
            chat.scrollTop = chat.scrollHeight;
        });

        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendBtn.click();
        });
    </script>
</body>

</html>