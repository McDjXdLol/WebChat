<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Chat web</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }

        #chat,
        #users-list-container {
            height: 100%;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        #chat::-webkit-scrollbar,
        #users-list-container::-webkit-scrollbar,
        #emoji-picker::-webkit-scrollbar {
            width: 8px;
        }

        #chat::-webkit-scrollbar-track,
        #users-list-container::-webkit-scrollbar-track,
        #emoji-picker::-webkit-scrollbar-track {
            background: #161b22;
        }

        #chat::-webkit-scrollbar-thumb,
        #users-list-container::-webkit-scrollbar-thumb,
        #emoji-picker::-webkit-scrollbar-thumb {
            background-color: #30363d;
            border-radius: 4px;
            border: 2px solid #161b22;
        }

        #emoji-picker {
            position: absolute;
            bottom: 60px;
            right: 15px;
            width: 320px;
            height: 300px;
            background-color: #21262d;
            border: 1px solid #30363d;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            display: none;
            flex-direction: column;
            z-index: 50;
            padding: 10px;
        }

        #emoji-picker.active {
            display: flex;
        }

        #emoji-tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
            border-bottom: 1px solid #30363d;
        }

        #emoji-tabs button {
            padding: 8px;
            font-size: 1.25rem;
            color: #c9d1d9;
            border: none;
            background: none;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.1s ease;
        }

        #emoji-tabs button:hover {
            color: #58a6ff;
            transform: scale(1.1);
        }

        #emoji-tabs button.active {
            color: #58a6ff;
            border-bottom: 2px solid #58a6ff;
        }

        #emoji-list {
            flex-grow: 1;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            overflow-y: auto;
        }

        .emoji-item {
            cursor: pointer;
            font-size: 24px;
            padding: 4px;
            transition: transform 0.1s ease-in-out;
        }

        .emoji-item:hover {
            transform: scale(1.2);
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4 pb-20">
    <div
        class="bg-[#161b22] rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-6xl mx-auto border border-[#30363d] flex h-[88vh]">
        <div class="flex flex-col flex-grow mr-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl md:text-3xl font-extrabold text-[#58a6ff]">Welcome, <span id="user"></span>!</h2>
                <div class="flex items-center space-x-2 text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-users-2 text-[#c9d1d9]">
                        <path d="M14 19a6 6 0 0 0-12 0" />
                        <circle cx="8" cy="9" r="4" />
                        <path d="M22 19a6 6 0 0 0-6-6 6 6 0 0 0-6 6" />
                        <path d="M16 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                    </svg>
                    <span id="online-users-count" class="font-bold text-lg">0</span>
                </div>

            </div>

            <div id="chat" class="flex-grow p-4 mb-4 rounded-xl border border-[#30363d] space-y-4 bg-[#0d1117]">
                <div class="flex items-start space-x-3 p-3 bg-[#21262d] rounded-xl">
                    <img class="w-8 h-8 rounded-full object-cover flex-shrink-0" src="/static/images/info.png"
                        alt="Info icon">
                    <div>
                        <div class="flex items-center mb-1 space-x-2">
                            <span class="font-bold text-sm text-[#ff0000]">INFO</span>
                        </div>
                        <p class="text-sm">Type !info for more information.</p>
                    </div>
                </div>
            </div>

            <div id="typing-indicator" class="text-sm text-gray-400 mt-2" style="display:block;">‎ </div>

            <div class="flex items-center space-x-2 relative">
                <input id="input" placeholder="Wpisz wiadomość..." autocomplete="off"
                    class="flex-grow bg-[#21262d] text-[#c9d1d9] border border-[#30363d] rounded-xl p-3 focus:outline-none focus:border-[#58a6ff]">

                <div id="emoji-picker" class="hidden">
                    <div id="emoji-tabs">
                    </div>
                    <div id="emoji-list">
                    </div>
                </div>

                <button id="emoji-button" class="bg-[#21262d] text-[#c9d1d9] p-2 rounded-xl border border-[#30363d] shadow-lg
                           hover:bg-[#30363d] transition-colors duration-300">
                    😀
                </button>
                <button id="send" class="bg-[#21262d] text-[#c9d1d9] font-bold py-3 px-6 rounded-xl border border-[#30363d] shadow-lg
                           hover:bg-[#30363d] transition-colors duration-300">
                    Send
                </button>
            </div>
        </div>

        <div class="w-64 flex-shrink-0 flex flex-col bg-[#161b22] rounded-xl border border-[#30363d] p-4">
            <h3 class="text-xl font-bold text-[#c9d1d9] mb-4">Online Users</h3>
            <div id="users-list-container" class="flex-grow overflow-y-auto">
                <ul id="online-users-list" class="space-y-2">
                </ul>
            </div>
        </div>
    </div>

    <footer
        class="fixed bottom-0 w-full p-4 bg-[#161b22] text-[#c9d1d9] flex justify-center items-center rounded-t-2xl border-t border-[#30363d] shadow-2xl">
        <a href="{{ url_for('about') }}" target="_blank" class="text-sm">About</a>
    </footer>
</body>
<script>
    if ("Notification" in window && Notification.permission !== "granted") {
        Notification.requestPermission().then(permission => {
            if (permission !== "granted") {
                console.warn("Notifications blocked by user 😢");
            }
        });
    }
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const userSpan = document.getElementById('user');

    const emojiButton = document.getElementById('emoji-button');
    const emojiPicker = document.getElementById('emoji-picker');
    const emojiTabs = document.getElementById('emoji-tabs');
    const emojiListContainer = document.getElementById('emoji-list');

    const categorizedEmojis = {
        'Faces': ["😀", "😁", "😂", "🤣", "😃", "😄", "😅", "😆", "�", "😊", "😎", "😍", "😘", "🥰", "😗", "😙", "😚", "🙂", "🤗", "🤩", "🤔", "🤨", "😐", "😑", "😶", "🙄", "😏", "😣", "😥", "😮", "🤐", "😯", "😪", "😫", "🥱", "😴", "😌", "😛", "😜", "😝", "🤤", "😒", "😓", "😔", "😕", "🙃", "🤑", "😲", "☹️", "🙁", "😖", "😞", "😟", "😤", "😢", "😭", "😦", "😧", "😨", "😩", "🤯", "😬", "😰", "😱", "🥵", "🥶", "😳", "🤪", "😵", "😡", "😠", "🤬", "😷", "🤒", "🤕", "🤢", "🤮", "🤧", "😇", "🥳", "🥺", "🤠", "🤡", "🤥", "🤫", "🤭", "🧐", "🤓", "😈", "👿", "👹", "👺", "💀", "👻", "👽", "🤖", "💩", "😺", "😸", "😹", "😻", "😼", "😽", "🙀", "😿", "😾"],
        'People': ["👋", "🤚", "🖐️", "✋", "🖖", "👌", "🤌", "🤏", "✌️", "🤞", "🤟", "🤘", "🤙", "👈", "👉", "👆", "🖕", "👇", "☝️", "👍", "👎", "✊", "👊", "🤛", "🤜", "👏", "🙌", "👐", "🤲", "🤝", "🙏", "✍️", "💅", "🤳", "💪", "🦾", "🦿", "🦵", "🦶", "👂", "🦻", "👃", "🧠", "🫀", "🫁", "🦷", "🦴", "👀", "👁️", "👅", "👄", "🫦", "👶", "🧒", "👦", "👧", "🧑", "👱", "👨", "👩", "🧔", "🧔‍♂️", "🧔‍♀️", "👨‍🦰", "👩‍🦰", "👨‍🦱", "👩‍🦱", "👨‍🦳", "👩‍🦳", "👨‍🦲", "👩‍🦲", "🧓", "👴", "👵", "🙍", "🙍‍♂️", "🙍‍♀️", "🙎", "🙎‍♂️", "🙎‍♀️", "🙅", "🙅‍♂️", "🙅‍♀️", "🙆", "🙆‍♂️", "🙆‍♀️", "💁", "💁‍♂️", "💁‍♀️", "🙋", "🙋‍♂️", "🙋‍♀️", "🧏", "🧏‍♂️", "🧏‍♀️", "🙇", "🙇‍♂️", "🙇‍♀️", "🤦", "🤦‍♂️", "🤦‍♀️", "🤷", "🤷‍♂️", "🤷‍♀️", "🧑‍⚕️", "👨‍⚕️", "👩‍⚕️", "🧑‍🎓", "👨‍🎓", "👩‍🎓", "🧑‍🏫", "👨‍🏫", "👩‍🏫", "🧑‍⚖️", "👨‍⚖️", "👩‍⚖️", "🧑‍🌾", "👨‍🌾", "👩‍🌾", "🧑‍🍳", "👨‍🍳", "👩‍🍳", "🧑‍🔧", "👨‍🔧", "👩‍🔧", "🧑‍🏭", "👨‍🏭", "👩‍🏭", "🧑‍💼", "👨‍💼", "👩‍💼", "🧑‍🔬", "👨‍🔬", "👩‍🔬", "🧑‍💻", "👨‍💻", "👩‍💻", "🧑‍🎤", "👨‍🎤", "👩‍🎤", "🧑‍🎨", "👨‍🎨", "👩‍🎨", "🧑‍✈️", "👨‍✈️", "👩‍✈️", "🧑‍🚀", "👨‍🚀", "👩‍🚀", "🧑‍🚒", "👨‍🚒", "👩‍🚒"],
        'Animals': ["🐶", "🐱", "🐭", "🐹", "🐰", "🦊", "🐻", "🐼", "🐨", "🐯", "🦁", "🐮", "🐷", "🐸", "🐵", "🙈", "🙉", "🙊", "🐔", "🐧", "🐦", "🐤", "🦆", "🦅", "🦉", "🦇", "🐺", "🐗", "🐴", "🦄", "🐝", "🐛", "🦋", "🐌", "🐞", "🐜", "🦗", "🕷️", "🦂", "🦟", "🦠", "🐢", "🐍", "🦎", "🦖", "🦕", "🐙", "🦑", "🦐", "🦞", "🦀", "🐡", "🐠", "🐟", "🐬", "🐳", "🐋", "🦈", "🐊", "🐅", "🐆", "🦓", "🦌", "🦧", "🦣", "🐘", "🦏", "🦛", "🦒", "🦘", "🐃", "🐂", "🐄", "🐎", "🐖", "🐏", "🐑", "🐐", "🐪", "🐫", "🦙", "🦘", "🦥", "🦦", "🦨", "🦡", "🦔", "🐾"],
        'Food': ["🍏", "🍎", "🍐", "🍊", "🍋", "🍌", "🍉", "🍇", "🍓", "🍈", "🍒", "🍑", "🥭", "🍍", "🥥", "🥝", "🍅", "🍆", "🥑", "🥦", "🥬", "🥒", "🌶️", "🌽", "🥕", "🧄", "🧅", "🥔", "🍠", "🥐", "🍞", "🥖", "🥨", "🥯", "🥞", "🧇", "🧀", "🍖", "🍗", "🥩", "🥓", "🍔", "🍟", "🍕", "🌭", "🥪", "🌮", "🌯", "🥙", "🧆", "🥚", "🍳", "🥘", "🍲", "🥣", "🥗", "🍿", "🧈", "🧂", "🥫", "🍱", "🍘", "🍙", "🍚", "🍛", "🍜", "🍝", "🍠", "🍢", "🍣", "🍤", "🍥", "🍡", "🥠", "🥮", "🥡", "🍦", "🍧", "🍨", "🍩", "🍪", "🎂", "🍰", "🧁", "🥧", "🍫", "🍬", "🍭", "🍮", "🍯", "🍼", "🥛", "☕", "🍵", "🍶", "🍾", "🍷", "🍸", "🍹", "🍺", "🍻", "🥂", "🥃", "🥤", "🧋", "🧃", "🧉", "🧊", "🥢", "🍽️", "🍴", "🥄", "🔪", "🏺"],
        'Symbols': ["❤️", "🧡", "💛", "💚", "💙", "💜", "🖤", "🤍", "🤎", "💔", "❣️", "💕", "💞", "💓", "💗", "💖", "💘", "💝", "💯", "💢", "💥", "💫", "💦", "💨", "🕳️", "💣", "💬", "👁️‍🗨️", "🗨️", "🗯️", "💭", "💤"]
    };

    const categoryIcons = {
        'Faces': '😀',
        'People': '👋',
        'Animals': '🐶',
        'Food': '🍔',
        'Symbols': '❤️'
    };

    function createEmojiPicker() {
        emojiTabs.innerHTML = '';
        emojiListContainer.innerHTML = '';

        Object.keys(categorizedEmojis).forEach((category, index) => {
            const tabButton = document.createElement('button');
            tabButton.innerText = categoryIcons[category];
            tabButton.dataset.category = category;
            if (index === 0) {
                tabButton.classList.add('active');
            }
            tabButton.addEventListener('click', () => showCategory(category));
            emojiTabs.appendChild(tabButton);
        });

        showCategory(Object.keys(categorizedEmojis)[0]);
    }

    function showCategory(category) {
        emojiListContainer.innerHTML = '';
        const emojis = categorizedEmojis[category];
        emojis.forEach(emoji => {
            const emojiSpan = document.createElement('span');
            emojiSpan.classList.add('emoji-item');
            emojiSpan.innerText = emoji;
            emojiSpan.addEventListener('click', () => {
                input.value += emoji;
                input.focus();
            });
            emojiListContainer.appendChild(emojiSpan);
        });

        const allTabs = emojiTabs.querySelectorAll('button');
        allTabs.forEach(tab => tab.classList.remove('active'));
        const activeTab = emojiTabs.querySelector(`[data-category="${category}"]`);
        if (activeTab) {
            activeTab.classList.add('active');
        }
    }


    emojiButton.addEventListener('click', (e) => {
        e.stopPropagation();
        emojiPicker.classList.toggle('active');
        if (emojiPicker.classList.contains('active')) {
            createEmojiPicker();
        }
    });

    document.addEventListener('click', (e) => {
        if (!emojiPicker.contains(e.target) && !emojiButton.contains(e.target)) {
            emojiPicker.classList.remove('active');
        }
    });

    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('username') || 'anonim';
    const usercolor = urlParams.get('color') || '#c9d1d9';

    userSpan.innerText = username;
    userSpan.style.color = usercolor;

    input.addEventListener('keydown', (e) => {
        if (e.key === "Enter") {
            socket.emit('user_typing', {
                username: username,
                color: usercolor,
                done: true
            });
            sendBtn.click();
        } else {
            socket.emit('user_typing', {
                username: username,
                color: usercolor,
                done: false
            });
        }
    });

    const socket = io();

    let pingStart = null;

    socket.on('show_typing', (data) => {
        const typingIndicator = document.getElementById('typing-indicator');
        if (!data.done) {
            typingIndicator.innerText = `${data.username} is typing...`;
            typingIndicator.style.display = 'block';
        } else {
            typingIndicator.style.display = 'none';
        }
    });

    function sendPing() {
        pingStart = Date.now();
        socket.emit('send_message', {
            username: username,
            color: usercolor,
            text: "!ping"
        });
    }

    socket.on('connect', () => {
        socket.emit('register_user', {
            username: username,
            color: usercolor
        });
        socket.emit('user_count');
    });

    socket.on('update_users_online', (data) => {
        const onlineUsersSpan = document.getElementById('online-users-count');
        const onlineUsersList = document.getElementById('online-users-list');

        if (data && data.users) {
            onlineUsersSpan.innerText = data.users.length;
            onlineUsersList.innerHTML = '';
            data.users.forEach(userObj => {
                const listItem = document.createElement('li');
                listItem.classList.add('flex', 'items-center', 'space-x-2', 'p-2', 'rounded-md', 'bg-[#21262d]');

                const avatarImg = document.createElement('img');
                avatarImg.classList.add('w-8', 'h-8', 'rounded-full', 'flex-shrink-0');

                const userColor = userObj.color.replace('#', '');

                avatarImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userObj.username)}&background=${userColor}&color=ffffff&bold=true&format=png`;

                const usernameSpan = document.createElement('span');
                usernameSpan.classList.add('font-medium', 'text-sm');
                usernameSpan.innerText = userObj.username === username ? userObj.username + " (You)" : userObj.username;

                listItem.appendChild(avatarImg);
                listItem.appendChild(usernameSpan);
                onlineUsersList.appendChild(listItem);
            });
        }
    });


    socket.on('nickname_taken', () => {
        showModal("Ten nick jest już zajęty. Wybierz inny.");
    });

    socket.on('registration_successful', () => {
        console.log("Loged succesfully.");
    });

    userSpan.innerText = username;
    userSpan.style.color = usercolor;

    sendBtn.onclick = () => {
        const msg = input.value.trim();
        if (!msg) return;


        if (msg === "!ping") pingStart = Date.now();

        socket.emit('send_message', { username: username, color: usercolor, text: msg });
        input.value = '';
    };

    socket.on('receive_message', (data) => {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('flex', 'items-start', 'space-x-3');
        if (data.username === username) {
            messageDiv.classList.add('justify-end');
        } else {
            messageDiv.classList.add('justify-start');
        }
        const avatarImg = document.createElement('img');
        avatarImg.classList.add('w-8', 'h-8', 'rounded-full', 'flex-shrink-0');
        avatarImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(data.username)}&background=${data.color.replace('#', '')}&color=ffffff&bold=true&format=png`;

        const messageContent = document.createElement('div');
        messageContent.classList.add('bg-[#21262d]', 'p-3', 'rounded-xl', 'max-w-xs', 'md:max-w-md', 'break-words');

        const messageHeader = document.createElement('div');
        messageHeader.classList.add('flex', 'items-center', 'mb-1', 'space-x-2');

        const messageAuthor = document.createElement('span');
        messageAuthor.classList.add('font-bold', 'text-sm');
        messageAuthor.innerText = data.username;
        messageAuthor.style.color = data.color;

        const messageTime = document.createElement('span');
        messageTime.classList.add('text-xs', 'text-gray-500');
        const now = new Date();
        messageTime.innerText = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;

        messageHeader.appendChild(messageAuthor);
        messageHeader.appendChild(messageTime);

        const messageText = document.createElement('p');
        messageText.classList.add('text-sm');

        if (data.text.startsWith("<img src=")) {
            messageText.innerHTML = data.text;
        }
        else if (data.text == "<ping>") {
            const latency = Date.now() - pingStart;
            messageText.innerText = `Pong! ${latency}ms`;
        }
        else if (data.text == "<time>") {
            const clientTime = new Date();
            let hours = clientTime.getHours().toString().padStart(2, '0');
            let minutes = clientTime.getMinutes().toString().padStart(2, '0');
            let seconds = clientTime.getSeconds().toString().padStart(2, '0');
            messageText.innerText = `${hours}:${minutes}:${seconds}`;
        }
        else {
            messageText.innerText = data.text;
        }

        if (data.username !== username && document.hidden && Notification.permission === "granted") {
            let notif = new Notification(`${data.username}`, {
                body: data.text,
                icon: avatarImg.src
            });
            notif.onclick = () => window.focus();
        }

        messageContent.appendChild(messageHeader);
        messageContent.appendChild(messageText);

        messageDiv.appendChild(avatarImg);

        messageDiv.appendChild(messageContent);

        chat.appendChild(messageDiv);
        chat.scrollTop = chat.scrollHeight;
    });


    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendBtn.click();
    });

    function showModal(message) {
        const modal = document.createElement('div');
        modal.classList.add('fixed', 'inset-0', 'flex', 'items-center', 'justify-center', 'z-50', 'bg-black', 'bg-opacity-50');
        modal.innerHTML = `
            <div class="bg-[#161b22] p-6 rounded-lg shadow-xl border border-[#30363d] max-w-sm">
                <p class="text-white mb-4">${message}</p>
                <button id="modal-ok-btn" class="bg-[#58a6ff] hover:bg-[#4695ff] text-white font-bold py-2 px-4 rounded transition-colors duration-300">
                    OK
                </button>
            </div>
        `;
        document.body.appendChild(modal);
        document.getElementById('modal-ok-btn').addEventListener('click', () => {
            modal.remove();
            window.location.href = "/login";
        });
    }
</script>

</html>